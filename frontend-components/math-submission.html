<!-- Componente: Respuesta Matemática -->
<div id="math-problem-{id}" class="interactive-problem math-submission-problem">

  <div class="problem-header">
    <span class="problem-badge">∑ Respuesta matemática</span>
    <h4>{title}</h4>
  </div>

  <div class="problem-description">{description}</div>

  <div class="answer-input-container">
    <label for="answer-input-{id}">Tu respuesta</label>
    <input
      type="text"
      id="answer-input-{id}"
      class="answer-input"
      placeholder="Escribe el resultado aquí…"
      autocomplete="off"
      onkeydown="if(event.key==='Enter') submitMath('{id}')"
    >
  </div>

  <div class="problem-controls">
    <button class="btn btn-primary" onclick="submitMath('{id}')">
      ✓ Verificar respuesta
    </button>
    <button class="btn btn-secondary" onclick="resetMath('{id}')">
      ↺ Limpiar
    </button>
    <span id="loading-math-{id}" class="loading hidden">Verificando…</span>
  </div>

  <div id="feedback-math-{id}" class="feedback-container hidden">
    <div id="feedback-status-math-{id}"  class="feedback-status"></div>
    <div id="feedback-message-math-{id}" class="feedback-message"></div>
  </div>
</div>

<script>
(function () {
  const API_BASE = window.LINEAR_ALGEBRA_API_URL || 'http://localhost:8000/api/v1';

  window.submitMath = async function (problemId) {
    const input     = document.getElementById(`answer-input-${problemId}`);
    const feedback  = document.getElementById(`feedback-math-${problemId}`);
    const statusEl  = document.getElementById(`feedback-status-math-${problemId}`);
    const messageEl = document.getElementById(`feedback-message-math-${problemId}`);
    const loadingEl = document.getElementById(`loading-math-${problemId}`);
    const submitBtn = feedback.closest('.interactive-problem').querySelector('.btn-primary');

    const answer = input.value.trim();

    if (!answer) {
      _showStatus(statusEl, 'error', '⚠ Por favor escribe tu respuesta antes de verificar.');
      messageEl.textContent = '';
      feedback.classList.remove('hidden');
      return;
    }

    loadingEl.classList.remove('hidden');
    feedback.classList.add('hidden');
    submitBtn.disabled = true;

    try {
      const res = await fetch(`${API_BASE}/submit/math`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ problem_id: problemId, answer, user_id: null }),
      });

      if (!res.ok) {
        const detail = await res.json().catch(() => ({}));
        throw new Error(detail.detail || `Error del servidor (${res.status})`);
      }

      const data = await res.json();

      _showStatus(
        statusEl,
        data.is_correct ? 'correct' : 'incorrect',
        data.is_correct ? '✓ ¡Correcto!' : '✗ Respuesta incorrecta'
      );
      messageEl.textContent = data.feedback || '';

    } catch (err) {
      _showStatus(statusEl, 'error', '⚠ No se pudo conectar al servidor');
      messageEl.textContent =
        `${err.message}\n\nAsegúrate de que el backend está corriendo en http://localhost:8000`;
    } finally {
      loadingEl.classList.add('hidden');
      submitBtn.disabled = false;
      document.getElementById(`feedback-math-${problemId}`).classList.remove('hidden');
    }
  };

  window.resetMath = function (problemId) {
    document.getElementById(`answer-input-${problemId}`).value = '';
    document.getElementById(`feedback-math-${problemId}`).classList.add('hidden');
  };

  function _showStatus(el, type, text) {
    el.className = `feedback-status ${type}`;
    el.textContent = text;
  }
})();
</script>
