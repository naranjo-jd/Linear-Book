<!-- Componente: Envío de Código Python -->
<div id="code-problem-{id}" class="interactive-problem code-submission-problem">

  <div class="problem-header">
    <span class="problem-badge">⌨ Código Python</span>
    <h4>{title}</h4>
  </div>

  <div class="problem-description">{description}</div>

  <div class="code-editor-container">
    <label for="code-input-{id}">Tu solución</label>
    <textarea
      id="code-input-{id}"
      class="code-editor-input"
      spellcheck="false"
      autocomplete="off"
      placeholder="# Escribe tu código Python aquí..."
    >{initial_code}</textarea>
  </div>

  <div class="problem-controls">
    <button class="btn btn-primary" onclick="submitCode('{id}')">
      ▶ Ejecutar y verificar
    </button>
    <button class="btn btn-secondary" onclick="resetCode('{id}', `{initial_code}`)">
      ↺ Restablecer
    </button>
    <span id="loading-{id}" class="loading hidden">Ejecutando…</span>
  </div>

  <div id="feedback-{id}" class="feedback-container hidden">
    <div id="feedback-status-{id}"  class="feedback-status"></div>
    <div id="feedback-message-{id}" class="feedback-message"></div>
    <div id="feedback-output-{id}"  class="feedback-output"></div>
  </div>
</div>

<script>
(function () {
  // URL del API — se puede sobreescribir globalmente con window.LINEAR_ALGEBRA_API_URL
  const API_BASE = window.LINEAR_ALGEBRA_API_URL || 'http://localhost:8000/api/v1';

  window.submitCode = async function (problemId) {
    const textarea   = document.getElementById(`code-input-${problemId}`);
    const feedback   = document.getElementById(`feedback-${problemId}`);
    const statusEl   = document.getElementById(`feedback-status-${problemId}`);
    const messageEl  = document.getElementById(`feedback-message-${problemId}`);
    const outputEl   = document.getElementById(`feedback-output-${problemId}`);
    const loadingEl  = document.getElementById(`loading-${problemId}`);
    const submitBtn  = feedback.closest('.interactive-problem').querySelector('.btn-primary');

    const code = textarea.value.trim();

    if (!code) {
      _showStatus(statusEl, 'error', '⚠ Por favor escribe tu código antes de enviar.');
      messageEl.textContent = '';
      outputEl.textContent  = '';
      feedback.classList.remove('hidden');
      return;
    }

    // Estado de carga
    loadingEl.classList.remove('hidden');
    feedback.classList.add('hidden');
    submitBtn.disabled = true;

    try {
      const res = await fetch(`${API_BASE}/submit/code`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ problem_id: problemId, code, user_id: null }),
      });

      if (!res.ok) {
        const detail = await res.json().catch(() => ({}));
        throw new Error(detail.detail || `Error del servidor (${res.status})`);
      }

      const data = await res.json();

      _showStatus(
        statusEl,
        data.is_correct ? 'correct' : 'incorrect',
        data.is_correct ? '✓ ¡Correcto!' : '✗ Respuesta incorrecta'
      );
      messageEl.textContent = data.feedback || '';

      if (data.execution_output) {
        outputEl.textContent = `$ Salida:\n${data.execution_output}`;
      } else if (data.execution_error) {
        outputEl.textContent = `$ Error:\n${data.execution_error}`;
      } else {
        outputEl.textContent = '';
      }

    } catch (err) {
      _showStatus(statusEl, 'error', '⚠ No se pudo conectar al servidor');
      messageEl.textContent =
        `${err.message}\n\nAsegúrate de que el backend está corriendo en http://localhost:8000`;
      outputEl.textContent = '';
    } finally {
      loadingEl.classList.add('hidden');
      submitBtn.disabled = false;
      document.getElementById(`feedback-${problemId}`).classList.remove('hidden');
    }
  };

  window.resetCode = function (problemId, initialCode) {
    document.getElementById(`code-input-${problemId}`).value = initialCode || '';
    document.getElementById(`feedback-${problemId}`).classList.add('hidden');
  };

  function _showStatus(el, type, text) {
    el.className = `feedback-status ${type}`;
    el.textContent = text;
  }
})();
</script>
